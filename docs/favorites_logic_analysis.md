# Favorites画面 (`https://grok.com/imagine/favorites`) における画像保存ロジック解析

現在 (v2.2) の `content.js` および `background.js` に実装されているロジックは以下の通りです。

## 1. 検知フェーズ (`content.js`)

Webページ上で画像が表示されると、以下の条件で「保存対象」かどうかを判定します。

1.  **URLチェック**: ブラウザのURLが `/favorites` を含んでいるか確認。
    *   `isFavorites = window.location.href.includes("/favorites")` -> **True**
2.  **画像フィルタリング**:
    *   `src` が既にこのセッションで処理済みでないか (`processedCache`)。
    *   **対象判定**: `alt` 属性が "Generated image" であるか、または `src` に "grok" が含まれているか。
    *   **サイズ判定**: 予測サイズが `minSizeKB` (v2.2では20KB) 以上か。
3.  **メッセージ送信**:
    *   条件を満たせば、`background.js` へメッセージを送信。
    *   パラメータ: `{ action: "download_image", isFavorites: true, ... }`
4.  **視覚フィードバック**:
    *   画像枠をピンク色 (`#ff00ff`) に点滅させる（通常時は緑）。

## 2. 保存判定フェーズ (`background.js`)

`background.js` がメッセージを受け取った後、実際に保存するかどうかを判定します。

1.  **ファイル名生成**: URLからファイル名を抽出 (例: `abcd.jpg`)。抽出できない場合はランダムなファイル名。
2.  **重複チェック (重要)**:
    *   `isFavorites` が **True** の場合:
        *   **ファイル名ベースの重複チェック** を行います。
        *   `grok_saver_filenames` ストレージを確認し、**同じファイル名が過去に保存されている場合は「保存しない」**。
    *   (参考: 通常時はハッシュ値ベースのチェック)

## 3. 挙動の分析と課題の可能性

### 現状の挙動
「過去に一度でも保存された画像（ファイル名が履歴にある画像）」は、**Favorites画面で再度表示されても保存されません。**

### 考えられる「機能しない」原因
1.  **タイムラインで閲覧済み**: 
    生成時やタイムラインで画像を一度見て、自動保存が成功している場合、そのファイル名が履歴に記録されます。その後 Favorites 画面を開いても、ファイル名重複チェックにより保存がスキップされます。
    *   これは「二重保存を防ぐ」ための仕様通りですが、「Favoritesフォルダに改めて振り分けたい」といった意図がある場合は機能していないように見えます（現状、保存先フォルダは日付フォルダ固定であり、Favorites専用フォルダには分けられません）。
2.  **ファイル名の不一致**:
    Favorites画面の画像URLが、通常の生成直後のURLと形式が異なる場合（例えばリサイズ版やCDNの変更など）、ファイル名が期待通りに生成されず、保存されない、あるいは逆に重複とみなされないなどの挙動になる能性があります。
    *   ただし、現状のロジックでは「重複してなければ保存する」ため、URLが変わっていれば逆に保存されるはずです。保存されないなら「重複している（とみなされている）」か「検知されていない」のどちらかです。
3.  **DOM構造の違い**:
    Favorites画面のHTML構造が変わり、`img` タグの `alt` が "Generated image" でなくなっている、あるいは `src` に "grok" が含まれていない場合、`content.js` の検知で弾かれている可能性があります。

## 結論
「タイムラインで見た画像がFavoritesで保存されない」のは、**ファイル名重複チェックによる仕様**である可能性が高いです。
もし「Favoritesで見た場合も強制的に保存したい」あるいは「Favoritesで見た場合は別の場所に保存したい」という場合は、ロジックの変更が必要です。
